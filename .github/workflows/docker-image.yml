name: Deploy to Production

on:
  push:
    branches: [ "main" ]

jobs:
  deploy:
    runs-on: ubuntu-latest
    timeout-minutes: 30
    
    steps:
    - name: Deploy to production server
      uses: appleboy/ssh-action@master
      with:
        host: ${{ secrets.SSH_HOST }}
        username: ${{ secrets.SSH_USER }}
        key: ${{ secrets.SSH_PRIVATE_KEY }}
        timeout: 30m
        script: |
          set -e
          
          echo "üöÄ D√©marrage du d√©ploiement..."
          
          # Aller dans le r√©pertoire du projet
          cd ~/foodtrack
          
          # Afficher le statut git
          echo "üìã Statut Git avant pull..."
          git status
          
          # R√©cup√©rer les derni√®res modifications
          echo "‚¨áÔ∏è  R√©cup√©ration du code..."
          git fetch origin
          
          # V√©rifier si on est sur main
          current_branch=$(git rev-parse --abbrev-ref HEAD)
          if [ "$current_branch" != "main" ]; then
            echo "‚ö†Ô∏è  Vous n'√™tes pas sur la branche main (actuellement: $current_branch)"
            echo "üîÄ Basculement sur main..."
            git checkout main
          fi
          
          # Pull les derni√®res modifications
          echo "‚¨áÔ∏è  Pull des modifications..."
          git pull origin main
          
          # V√©rifier que le script fix-all.sh existe
          if [ ! -f "fix-all.sh" ]; then
            echo "‚ùå ERREUR: fix-all.sh n'existe pas dans ~/foodtrack"
            exit 1
          fi
          
          # Rendre le script ex√©cutable
          chmod +x fix-all.sh
          
          # Ex√©cuter le script de d√©ploiement
          echo "üîÑ Ex√©cution du script de d√©ploiement..."
          ./fix-all.sh
          
          echo ""
          echo "‚úÖ D√©ploiement termin√© avec succ√®s !"
