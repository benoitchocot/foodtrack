// This is your Prisma schema file,
// learn more about it in the docs: https://pris.ly/d/prisma-schema

generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

// ============================================
// ENUMS
// ============================================

enum DietType {
  VEGETARIAN
  VEGAN
  HALAL
  KOSHER
  NO_PORK
  NO_BEEF
  PESCATARIAN
  GLUTEN_FREE
  DAIRY_FREE
  NUT_FREE
}

enum Difficulty {
  EASY
  MEDIUM
  HARD
}

enum IngredientCategory {
  FRESH
  DAIRY
  MEAT
  FISH
  PANTRY
  FROZEN
  BAKERY
  BEVERAGES
  SPICES
  OTHER
}

enum Unit {
  G
  KG
  ML
  L
  PIECE
  BUNCH
  PINCH
  TBSP
  TSP
  CUP
  CLOVE
  SLICE
}

enum ShoppingListStatus {
  DRAFT
  FINALIZED
}

enum RecipeSubmissionStatus {
  PENDING
  APPROVED
  REJECTED
}

// ============================================
// USERS & AUTHENTICATION
// ============================================

model User {
  id              String   @id @default(uuid())
  email           String   @unique
  passwordHash    String   @map("password_hash")
  firstName       String?  @map("first_name")
  lastName        String?  @map("last_name")
  hasSeenTutorial Boolean  @default(false) @map("has_seen_tutorial")
  createdAt       DateTime @default(now()) @map("created_at")
  updatedAt       DateTime @updatedAt @map("updated_at")

  settings          UserSettings?
  mealPlans         MealPlan[]
  shoppingLists     ShoppingList[]
  recipeViews       RecipeView[]
  favorites         Favorite[]
  recipeSubmissions RecipeSubmission[]
  reviews           RecipeReview[]
  reviewReports     ReviewReport[]

  @@map("users")
}

model UserSettings {
  id                   String      @id @default(uuid())
  userId               String      @unique @map("user_id")
  householdSize        Int         @default(2) @map("household_size")
  defaultMealsPerWeek  Int         @default(5) @map("default_meals_per_week")
  dietPreferences      DietType[]  @map("diet_preferences")
  toolsAvailable       String[]    @map("tools_available") // ["oven", "microwave", "blender"]
  difficultyPreference Difficulty? @map("difficulty_preference")
  maxPrepTime          Int?        @map("max_prep_time") // in minutes
  createdAt            DateTime    @default(now()) @map("created_at")
  updatedAt            DateTime    @updatedAt @map("updated_at")

  user User @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@map("user_settings")
}

// ============================================
// RECIPES & INGREDIENTS
// ============================================

model Recipe {
  id            String     @id @default(uuid())
  title         String
  slug          String     @unique
  description   String?    @db.Text
  imageUrl      String?    @map("image_url")
  prepTime      Int        @map("prep_time") // minutes
  cookTime      Int        @map("cook_time") // minutes
  difficulty    Difficulty
  servings      Int        @default(1) // Number of servings the recipe is designed for
  isAdaptable   Boolean    @default(true) @map("is_adaptable") // If false, quantities are fixed (e.g., tarts, cakes)
  tags          String[] // ["quick", "batch_cooking", "one_pot"]
  toolsRequired String[]   @map("tools_required") // ["oven", "blender"]
  dietTypes     DietType[] @map("diet_types")
  // Nutritional values (per serving, nullable)
  calories      Int? // Total calories per serving
  carbohydrates Decimal?   @db.Decimal(10, 2) // Grams of carbohydrates per serving
  fats          Decimal?   @db.Decimal(10, 2) // Grams of fats per serving
  proteins      Decimal?   @db.Decimal(10, 2) // Grams of proteins per serving
  fibers        Decimal?   @db.Decimal(10, 2) // Grams of fibers per serving
  createdAt     DateTime   @default(now()) @map("created_at")
  updatedAt     DateTime   @updatedAt @map("updated_at")

  steps           RecipeStep[]
  ingredients     RecipeIngredient[]
  mealPlanRecipes MealPlanRecipe[]
  views           RecipeView[]
  favorites       Favorite[]
  editSubmissions RecipeSubmission[]
  reviews         RecipeReview[]

  @@index([difficulty])
  @@index([prepTime])
  @@map("recipes")
}

model RecipeSubmission {
  id            String                 @id @default(uuid())
  userId        String                 @map("user_id")
  status        RecipeSubmissionStatus @default(PENDING)
  approvalToken String                 @unique @map("approval_token")
  recipeId      String?                @map("recipe_id") // For edit submissions

  // Recipe data (same structure as Recipe)
  title         String
  description   String?    @db.Text
  imageUrl      String?    @map("image_url")
  prepTime      Int        @map("prep_time")
  cookTime      Int        @map("cook_time")
  difficulty    Difficulty
  servings      Int        @default(1)
  tags          String[]
  toolsRequired String[]   @map("tools_required")
  dietTypes     DietType[] @map("diet_types")
  // Nutritional values (per serving, nullable)
  calories      Int?
  carbohydrates Decimal?   @db.Decimal(10, 2)
  fats          Decimal?   @db.Decimal(10, 2)
  proteins      Decimal?   @db.Decimal(10, 2)
  fibers        Decimal?   @db.Decimal(10, 2)

  // Submission metadata
  submittedAt     DateTime  @default(now()) @map("submitted_at")
  reviewedAt      DateTime? @map("reviewed_at")
  rejectionReason String?   @map("rejection_reason") @db.Text

  // Relations
  user        User                         @relation(fields: [userId], references: [id], onDelete: Cascade)
  recipe      Recipe?                      @relation(fields: [recipeId], references: [id], onDelete: SetNull)
  ingredients RecipeSubmissionIngredient[]
  steps       RecipeSubmissionStep[]

  @@index([userId])
  @@index([status])
  @@index([approvalToken])
  @@index([recipeId])
  @@map("recipe_submissions")
}

model RecipeSubmissionIngredient {
  id             String  @id @default(uuid())
  submissionId   String  @map("submission_id")
  ingredientId   String? @map("ingredient_id") // Can be null if ingredient doesn't exist yet
  ingredientName String  @map("ingredient_name") // Fallback if ingredient doesn't exist
  quantity       Decimal @db.Decimal(10, 2)
  unit           Unit
  optional       Boolean @default(false)

  submission RecipeSubmission @relation(fields: [submissionId], references: [id], onDelete: Cascade)
  ingredient Ingredient?      @relation(fields: [ingredientId], references: [id], onDelete: SetNull)

  @@map("recipe_submission_ingredients")
}

model RecipeSubmissionStep {
  id           String   @id @default(uuid())
  submissionId String   @map("submission_id")
  stepNumber   Int      @map("step_number")
  instruction  String   @db.Text
  createdAt    DateTime @default(now()) @map("created_at")

  submission RecipeSubmission @relation(fields: [submissionId], references: [id], onDelete: Cascade)

  @@unique([submissionId, stepNumber])
  @@map("recipe_submission_steps")
}

model RecipeStep {
  id          String   @id @default(uuid())
  recipeId    String   @map("recipe_id")
  stepNumber  Int      @map("step_number")
  instruction String   @db.Text
  createdAt   DateTime @default(now()) @map("created_at")

  recipe Recipe @relation(fields: [recipeId], references: [id], onDelete: Cascade)

  @@unique([recipeId, stepNumber])
  @@map("recipe_steps")
}

model Ingredient {
  id          String             @id @default(uuid())
  name        String             @unique
  category    IngredientCategory
  defaultUnit Unit               @map("default_unit")
  createdAt   DateTime           @default(now()) @map("created_at")
  updatedAt   DateTime           @updatedAt @map("updated_at")

  recipeIngredients           RecipeIngredient[]
  shoppingListItems           ShoppingListItem[]
  recipeSubmissionIngredients RecipeSubmissionIngredient[]

  @@index([category])
  @@map("ingredients")
}

model RecipeIngredient {
  id           String  @id @default(uuid())
  recipeId     String  @map("recipe_id")
  ingredientId String  @map("ingredient_id")
  quantity     Decimal @db.Decimal(10, 2)
  unit         Unit
  optional     Boolean @default(false)

  recipe     Recipe     @relation(fields: [recipeId], references: [id], onDelete: Cascade)
  ingredient Ingredient @relation(fields: [ingredientId], references: [id], onDelete: Cascade)

  @@unique([recipeId, ingredientId])
  @@map("recipe_ingredients")
}

// ============================================
// MEAL PLANNING
// ============================================

model MealPlan {
  id        String   @id @default(uuid())
  userId    String   @map("user_id")
  title     String
  createdAt DateTime @default(now()) @map("created_at")
  updatedAt DateTime @updatedAt @map("updated_at")

  user          User             @relation(fields: [userId], references: [id], onDelete: Cascade)
  recipes       MealPlanRecipe[]
  shoppingLists ShoppingList[]

  @@index([userId])
  @@map("meal_plans")
}

model MealPlanRecipe {
  id         String    @id @default(uuid())
  mealPlanId String    @map("meal_plan_id")
  recipeId   String    @map("recipe_id")
  plannedFor DateTime? @map("planned_for") @db.Date
  servings   Int
  createdAt  DateTime  @default(now()) @map("created_at")

  mealPlan MealPlan @relation(fields: [mealPlanId], references: [id], onDelete: Cascade)
  recipe   Recipe   @relation(fields: [recipeId], references: [id], onDelete: Cascade)

  @@unique([mealPlanId, recipeId])
  @@map("meal_plan_recipes")
}

// ============================================
// SHOPPING LISTS
// ============================================

model ShoppingList {
  id         String             @id @default(uuid())
  userId     String             @map("user_id")
  mealPlanId String?            @map("meal_plan_id")
  title      String
  status     ShoppingListStatus @default(DRAFT)
  createdAt  DateTime           @default(now()) @map("created_at")
  updatedAt  DateTime           @updatedAt @map("updated_at")

  user     User               @relation(fields: [userId], references: [id], onDelete: Cascade)
  mealPlan MealPlan?          @relation(fields: [mealPlanId], references: [id], onDelete: SetNull)
  items    ShoppingListItem[]

  @@index([userId])
  @@map("shopping_lists")
}

model ShoppingListItem {
  id             String   @id @default(uuid())
  shoppingListId String   @map("shopping_list_id")
  ingredientId   String   @map("ingredient_id")
  quantity       Decimal  @db.Decimal(10, 2)
  unit           Unit
  checked        Boolean  @default(false)
  createdAt      DateTime @default(now()) @map("created_at")
  updatedAt      DateTime @updatedAt @map("updated_at")

  shoppingList ShoppingList @relation(fields: [shoppingListId], references: [id], onDelete: Cascade)
  ingredient   Ingredient   @relation(fields: [ingredientId], references: [id], onDelete: Cascade)

  @@unique([shoppingListId, ingredientId])
  @@map("shopping_list_items")
}

// ============================================
// HISTORY & TRACKING
// ============================================

model RecipeView {
  id       String   @id @default(uuid())
  userId   String   @map("user_id")
  recipeId String   @map("recipe_id")
  viewedAt DateTime @default(now()) @map("viewed_at")

  user   User   @relation(fields: [userId], references: [id], onDelete: Cascade)
  recipe Recipe @relation(fields: [recipeId], references: [id], onDelete: Cascade)

  @@index([userId])
  @@index([recipeId])
  @@index([viewedAt])
  @@map("recipe_views")
}

model Favorite {
  id        String   @id @default(uuid())
  userId    String   @map("user_id")
  recipeId  String   @map("recipe_id")
  createdAt DateTime @default(now()) @map("created_at")

  user   User   @relation(fields: [userId], references: [id], onDelete: Cascade)
  recipe Recipe @relation(fields: [recipeId], references: [id], onDelete: Cascade)

  @@unique([userId, recipeId])
  @@index([userId])
  @@index([recipeId])
  @@map("favorites")
}

model RecipeReview {
  id        String   @id @default(uuid())
  userId    String   @map("user_id")
  recipeId  String   @map("recipe_id")
  rating    Int // 1-5 stars
  comment   String?  @db.Text
  createdAt DateTime @default(now()) @map("created_at")
  updatedAt DateTime @updatedAt @map("updated_at")

  user    User           @relation(fields: [userId], references: [id], onDelete: Cascade)
  recipe  Recipe         @relation(fields: [recipeId], references: [id], onDelete: Cascade)
  reports ReviewReport[]

  @@unique([userId, recipeId]) // One review per user per recipe
  @@index([userId])
  @@index([recipeId])
  @@index([rating])
  @@map("recipe_reviews")
}

model ReviewReport {
  id            String   @id @default(uuid())
  reviewId      String   @map("review_id")
  userId        String   @map("user_id") // User who reported
  deletionToken String?  @unique @map("deletion_token") // Token for admin deletion (nullable for existing records)
  createdAt     DateTime @default(now()) @map("created_at")

  review RecipeReview @relation(fields: [reviewId], references: [id], onDelete: Cascade)
  user   User         @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@unique([reviewId, userId]) // One report per user per review
  @@index([reviewId])
  @@index([userId])
  @@index([deletionToken])
  @@map("review_reports")
}
